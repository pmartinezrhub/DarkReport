{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{%  trans "Edit find for" %} {{ report.target }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'DarkReport/style.css' %}">

</head>
{% block content %}
<div class="container mt-4">
    <h2>{% trans "Edit Find" %}</h2>
    <hr>
    <form method="post">
        {% csrf_token %}

        <!-- Vulnerability y CVE same row -->
        <div class="row mb-3">
            <!-- Vulnerability -->
            <div class="col-md-6">
                ⚠️{{ form.vulnerability.label_tag }}
                {{ form.vulnerability }}
                {{ form.vulnerability.errors }}
            </div>

            <!-- CVE  autocomplete -->
            <div class="col-md-6 position-relative">
                {{ form.cve.label_tag }}
                {{ form.cve }}
                {{ form.cve.errors }}
                <ul id="cve-suggestions" class="list-group cve-suggestions"></ul>
            </div>
        </div>
        <!-- Reconnaissance -->
        <div class="mb-3">
            🔭<label for="{{ form.reconnaissance.id_for_label }}">{% trans "Reconnaissance" %}</label>
            {{ form.reconnaissance }}
            {{ form.reconnaissance.errors }}
        </div>

        <!-- Weaponization -->
        <div class="mb-3">
            💣 <label for="{{ form.weaponization.id_for_label }}">{% trans "Weaponization" %}</label>
            {{ form.weaponization }}
            {{ form.weaponization.errors }}
        </div>

        <!-- Delivery -->
        <div class="mb-3">
            🚚 <label for="{{ form.delivery.id_for_label }}">{% trans "Delivery" %}</label>
            {{ form.delivery }}
            {{ form.delivery.errors }}
        </div>

        <!-- Exploitation -->
        <div class="mb-3">
           🪲<label for="{{ form.exploitation.id_for_label }}">{% trans "Exploitation" %}</label>
            {{ form.exploitation }}
            {{ form.exploitation.errors }}
        </div>

        <!-- Installation -->
        <div class="mb-3">
            🎁 <label for="{{ form.installation.id_for_label }}">{% trans "Installation" %}</label>
            {{ form.installation }}
            {{ form.installation.errors }}
        </div>

        <!-- Command/Control -->
        <div class="mb-3">
            🎮 <label for="{{ form.commandcontrol.id_for_label }}">{% trans "CommandControl" %}</label>
            {{ form.commandcontrol }}
            {{ form.commandcontrol.errors }}
        </div>

        <!-- Actions -->
        <div class="mb-3">
            👽 <label for="{{ form.actions.id_for_label }}">{% trans "Actions" %}</label>
            {{ form.actions }}
            {{ form.actions.errors }}
        </div>
        
        <!-- Priority -->
        <div class="mb-3">
            🚦<label for="{{ form.priority.id_for_label }}">{% trans "Priority" %}</label>
            {{ form.priority }}
            {{ form.priority.errors }}
        </div>

        <button type="submit" class="btn btn-dark">{% trans "Save" %}</button>
        <button type="button" class="btn btn-dark" onclick="window.history.back()">{% trans "Cancel" %}</button>
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#deleteFindModal">
            🗑️ {% trans "Delete" %}
        </button>
    </form>
</div>

<!-- Modal delete -->
<div class="modal fade" id="deleteFindModal" tabindex="-1" aria-labelledby="deleteFindModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'delete_find' find.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteFindModalLabel">{% trans "Confirm delete" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          {% trans "Are you sure to delete this find?" %}
          <ul>
            {% if find.reconnaissance %}<li>🔭 Reconnaissance: {{ find.reconnaissance }}</li>{% endif %}
            {% if find.weaponization %}<li>🔪 Weaponization: {{ find.weaponization }}</li>{% endif %}
            {% if find.vulnerability %}<li>⚠️ Vulnerability: {{ find.vulnerability }}</li>{% endif %}
            {% if find.cve %}<li>🧾 CVE: {{ find.cve }}</li>{% endif %}
            {% if find.delivery %}<li>🚚 Delivery: {{ find.delivery }}</li>{% endif %}
            {% if find.exploitation %}<li>🪲 Exploitation: {{ find.exploitation }}</li>{% endif %}
            {% if find.installation %}<li>🎁 Installation: {{ find.installation }}</li>{% endif %}
            {% if find.commandcontrol %}<li>🎮 Command/Control: {{ find.commandcontrol }}</li>{% endif %}
            {% if find.actions %}<li>👽 Actions: {{ find.actions }}</li>{% endif %}
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          
          <button type="submit" class="btn btn-danger">{% trans "Delete" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("id_cve");
    const suggestions = document.getElementById("cve-suggestions");
    let timer = null;
    const cache = {}; // cache local: cve_id -> result

    input.addEventListener("input", () => {
        const q = input.value.trim().toUpperCase();
        suggestions.innerHTML = "";

        if (timer) clearTimeout(timer);
        
        if (!q || !/^CVE-\d{4}-\d{4,7}$/.test(q)) return;

        timer = setTimeout(async () => {
            try {
                if (cache[q]) {
                    mostrarSugerencias([cache[q]]);
                    return;
                }

                const res = await fetch(`/cve-lookup/?q=${encodeURIComponent(q)}`);
                if (!res.ok) return;

                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) {
                    suggestions.innerHTML = `<li class="list-group-item">Not CVEs found</li>`;
                    return;
                }

               
                cache[q] = data[0];
                mostrarSugerencias([data[0]]);
            } catch (err) {
                console.error("Error searching CVE:", err);
            }
        }, 600); // 0.6 secs debounce
    });

    function mostrarSugerencias(items) {
        suggestions.innerHTML = "";
        items.forEach(item => {
            const li = document.createElement("li");
            li.className = "list-group-item list-group-item-action";
            li.style.cursor = "pointer";
            const desc = (item.descriptions && item.descriptions.length > 0) 
                          ? item.descriptions[0].value 
                          : "Without descriptio";
            li.textContent = `${item.id} — ${desc}`;
            li.addEventListener("click", () => {
                input.value = item.id;
                suggestions.innerHTML = "";
            });
            suggestions.appendChild(li);
        });
    }

    document.addEventListener("click", e => {
        if (!suggestions.contains(e.target) && e.target !== input) {
            suggestions.innerHTML = "";
        }
    });
});
</script>

{% endblock %}

