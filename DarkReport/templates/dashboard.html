{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% trans "Dashboard" %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'DarkReport/style.css' %}">
    <link rel="icon" href="{% static 'DarkReport/dark-report-logo.png' %}" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <a href="{% url 'dashboard' %}"><img src="{% static 'DarkReport/dark-report-logo.png' %}" width="100px"></a>
        <hr>
  <div class="space-x-4">
      {% if user.is_authenticated %}
          <span>{% trans "Welcome" %}, {{ username }}</span>

          <a href="{% url 'logout' %}" class="bg-red-600 px-3 py-1 rounded hover:bg-red-700">
              {% trans "Logout" %}
          </a>
      {% endif %}
  </div>
    <hr>
        {% trans "Projects" %}:
        <ul class="list-unstyled" id="project_list">
            {% for project in projects %}
                <li>
                    <a href="#" class="project-link"
                       data-project-id="{{ project.id }}"
                       data-description="{{ project.description|escapejs }}"
                       data-reports='[
                        {% for report in project.reports.all %}
                            {
                                "id": {{ report.id }},
                                "target": "{{ report.target|escapejs }}",
                                "finds": [
                                    {% for find in report.finds.all %}
                                       {"id": {{ forloop.counter }}, "vulnerability": "{{ find.vulnerability|escapejs }}", "priority": "{{ find.priority|escapejs }}"}{% if not forloop.last %},{% endif %}
                                    {% endfor %}
                                ]
                            }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                       ]'>
                        {{ project.project_name }}
                    </a>
                </li>
            {% empty %}
                <li class="text-muted" style="color:grey;">{% trans "No projects available." %}</li>
            {% endfor %}
        </ul>
        <hr>
        <button type="button" class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#newProjectModal" style="color:white">
            + {% trans "New Project" %}
        </button>

    </div>

    <!-- Main Content -->
   <div class="content" data-selected-project="{{ selected_project_id }}">
    {% block content %}
<div style="display:flex;align-items:center;justify-content:space-between">
  <h4 style="margin:0">{% trans "Dashboard" %}</h4>
  
  <div style="display:flex;gap:0.5rem">
    <div>{{ request.LANGUAGE_CODE }}</div>
      <form action="{% url 'set_language' %}" method="post" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="language" value="es">
        <input type="hidden" name="next" value="{{ request.path }}">
        <button type="submit" style="background:none;border:none;font-size:1.2rem;cursor:pointer">ðŸ‡ªðŸ‡¸</button>
      </form>

      <form action="{% url 'set_language' %}" method="post" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="language" value="en">
        <input type="hidden" name="next" value="{{ request.path }}">
        <button type="submit" style="background:none;border:none;font-size:1.2rem;cursor:pointer">ðŸ‡¬ðŸ‡§</button>
      </form>
  </div>

</div>

    <hr>
    <br>
    <br>
    
    <!--  estadistics -->
    <div class="stats mb-4 d-flex gap-4">
        <div class="stat card p-3 text-center" style="flex: 1;background-color: rgb(15, 20, 29);">
            <h6>{% trans "Projects" %}</h6>
            <p class="fs-4">{{ total_projects }}</p>
        </div>
        <div class="stat card p-3 text-center" style="flex: 1;background-color: rgb(15, 20, 29);">
            <h6>{% trans "Reports" %}</h6>
            <p class="fs-4">{{ total_reports }}</p>
        </div>
        <div class="stat card p-3 text-center" style="flex: 1;background-color: rgb(15, 20, 29);">
            <h6>{% trans "Finds" %}</h6>
            <p class="fs-4">{{ total_finds }}</p>
        </div>
    </div>

    <!-- Graphics -->

    <div id="charts" class="mb-24 d-flex gap-4 flex-wrap">

        <div class="chart-container" style="width: 450px; height: 250px;">
            CVEs
            <canvas id="cveChart"></canvas>
        </div>
        <div class="chart-container" style="width: 450px; height: 250px;">
            VULNS
            <canvas id="vulnChart"></canvas>
        </div>
    </div>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
   <div class="footy"><a href="https://pmartinezr.work" target="_blank">pmartinezr.work </a>- 2025 pmartinezr@proton.me</div>
    {% endblock %}
</div>



    <!-- Modal for New Project -->
    <div class="modal fade" id="newProjectModal" tabindex="-1" aria-labelledby="newProjectModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="newProjectForm" method="POST" action="{% url 'project_create' %}">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="newProjectModalLabel">{% trans "Create new project" %}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="id_project_name" class="form-label">{% trans "Project name" %}</label>
                <input type="text" name="project_name" class="form-control" id="id_project_name" required maxlength="50">
              </div>
              <div class="mb-3">
                <label for="id_description" class="form-label">{% trans "Description" %}</label>
                <textarea name="description" class="form-control" id="id_description" maxlength="50" rows="5"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
              <button type="submit" class="btn btn-primary">{% trans "Create" %}</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal confirm delete -->
    <div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="deleteProjectForm" method="POST">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="deleteProjectModalLabel">{% trans "Confirm Delete" %}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              {% trans "Are you sure you want to delete this project?" %}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
              <button type="submit" class="btn btn-danger">{% trans "Delete" %}</button>
            </div>
          </form>
        </div>
      </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    window.translations = {
        open: "{% trans 'Open' %}",
        export: "{% trans 'Export' %}",
        delete: "{% trans 'Delete' %}",
        reports: "{% trans 'Reports' %}",
        finds: "{% trans 'Finds' %}",
        very_high: "{% trans 'Very High' %}",
        high: "{% trans 'High' %}",
        medium: "{% trans 'Medium' %}",
        low: "{% trans 'Low' %}",
        find: "{% trans 'Find' %}",
    };
</script>


<script src="{% static '/DarkReport/js/dashboard.js' %}"></script>

</body>
</html>
