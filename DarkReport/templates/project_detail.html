{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DarkReport - {{ project.project_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'DarkReport/style.css' %}">
</head>
<body>
<div class="container my-4">
   
    <h6>{% trans "Project" %}:</h6><h4>{{ project.project_name }}</h4>
    <hr>
    <p>{{ project.description }}</p>
     {% if reports %}
       <p><strong>{% trans "Reports" %}: {{ reports.count }} | {% trans "Finds" %} {{ total_finds }}</strong></p>
        <div class="accordion" id="reportsAccordion">
            {% for report in reports %}

            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ report.id }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ report.id }}" aria-expanded="false" aria-controls="collapse{{ report.id }}">
                            {% trans "Report" %}: {{ report.target }} - {{ report.finds.count }} {% trans "Finds" %}
                        </button>
                         <!-- Button Export -->
                        <form method="post" action="{% url 'export_report' report.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-dark me-1">üì§ {% trans "Export" %}</button>
                        </form>
                        <!-- Button Borrar Report -->
                        <button type="button" class="btn btn-sm btn-dark ms-2" data-bs-toggle="modal" data-bs-target="#deleteReportModal{{ report.id }}">
                            üóëÔ∏è {% trans "Delete" %}
                        </button>
                    </div>
                </h2>
                <div id="collapse{{ report.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ report.id }}" data-bs-parent="#reportsAccordion">
                    <div class="accordion-body">
                        <ul class="list-group">
                        {% for find in report.finds_ordered %}
                            <li class="list-group-item priority-{{ find.priority }}">
                                <strong>
                                    {{ forloop.counter }}:
                                    {% if find.vulnerability %} ‚ö†Ô∏è {% trans "Vulnerability" %} - {{ find.vulnerability }}{% endif %}
                                    <span class="badge 
                                        {% if find.priority == 'very_high' %}bg-danger
                                        {% elif find.priority == 'high' %}bg-warning text-dark
                                        {% elif find.priority == 'medium' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {% if find.priority == 'very_high' %}{% trans "Very High" %}
                                        {% elif find.priority == 'high' %}{% trans "High" %}
                                        {% elif find.priority == 'medium' %}{% trans "Medium" %}
                                        {% else %}{% trans "Low" %}
                                        {% endif %}
                                    </span>
                                </strong>

                                <ul>
                                    {% if find.cve %}<li> {{ find.cve }}</li>{% endif %}
                                    {% if find.reconnaissance %}<li>üî≠ {% trans "Reconnaissance" %}:  <pre class="bg-dark text-light p-2 rounded">{{ find.reconnaissance }}</pre>{% endif %}
                                    {% if find.recon_file %}</li>
                                    <li>üìé File: <a href="{{ find.recon_file.url }}" target="_blank">{{ find.recon_file.name }}</a></li>
                                    {% endif %}
                                    {% if find.weaponization %}<li>üí£ {% trans "Weaponization" %}:<pre class="bg-dark text-light p-2 rounded">  {{ find.weaponization }}</pre></li>{% endif %}
                                    {% if find.delivery %}<li>üöö {% trans "Delivery" %}:<pre class="bg-dark text-light p-2 rounded"> {{ find.delivery }}</pre></li>{% endif %}
                                    {% if find.exploitation %}<li>ü™≤ {% trans "Exploitation" %}:<pre class="bg-dark text-light p-2 rounded">  {{ find.exploitation }}</pre></li>{% endif %}
                                    {% if find.installation %}<li>üéÅ {% trans "Installation" %}: <pre class="bg-dark text-light p-2 rounded">{{ find.installation }}</pre></li>{% endif %}
                                    {% if find.commandcontrol %}<li>üéÆ {% trans "Commandcontrol" %}:<pre class="bg-dark text-light p-2 rounded">{{ find.commandcontrol }}</pre></li>{% endif %}
                                    {% if find.actions %}<li>üëΩ{% trans "Actions" %}: <pre class="bg-dark text-light p-2 rounded">{{ find.actions }}</li>{% endif %}

                                    <a href="{% url 'edit_find' find.id %}" class="btn btn-sm btn-dark">‚úèÔ∏è {% trans "Edit" %}</a>
                                    <input type="button" value='üìÑ{% trans "Copy"  %}' class="btn btn-sm btn-dark copy-btn"
                                          data-copy-text="
                                              {{ forloop.counter }}: {% if find.vulnerability %} ‚ö†Ô∏è {% trans 'Vulnerability' %} - {{ find.vulnerability }}{% endif %}
                                              {% if find.cve %}CVE: {{ find.cve }}{% endif %}
                                              {% if find.reconnaissance %}üî≠ {% trans 'Reconnaissance' %}: {{ find.reconnaissance }}{% endif %}
                                              {% if find.weaponization %}üí£ {% trans 'Weaponization' %}: {{ find.weaponization }}{% endif %}
                                              {% if find.delivery %}üöö {% trans 'Delivery' %}: {{ find.delivery }}{% endif %}
                                              {% if find.exploitation %}ü™≤ {% trans 'Exploitation' %}: {{ find.exploitation }}{% endif %}
                                              {% if find.installation %}üéÅ {% trans 'Installation' %}: {{ find.installation }}{% endif %}
                                              {% if find.commandcontrol %}üéÆ  {% trans 'Commandcontrol' %}: {{ find.commandcontrol }}{% endif %}
                                              {% if find.actions %}üëΩ {% trans 'Actions' %}: {{ find.actions }}{% endif %}
                                              ">
                                </ul>
                            </li>
                        {% endfor %}
                        </ul>

                        <a href="{% url 'add_find' report.id %}" class="btn btn-sm btn-dark mt-2">
                            {% trans "Add find" %}
                        </a>
                    </div>
                </div>
            </div>

            <!-- Modal delete Report -->
            <div class="modal fade" id="deleteReportModal{{ report.id }}" tabindex="-1" aria-labelledby="deleteReportModalLabel{{ report.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form method="post" action="{% url 'delete_report' report.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                      <h5 class="modal-title" id="deleteReportModalLabel{{ report.id }}">{% trans "Confirm delete" %}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                      {% trans "Are you sure you want to delete this report?" %}
                      <ul>
                        <li>{% trans "Target" %}: {{ report.target }}</li>
                        <li>{% trans  "Total finds" %}: {{ report.finds.count }}</li>
                      </ul>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                      <button type="submit" class="btn btn-danger">{% trans "Delete" %}</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            {% endfor %}
        </div>
    {% else %}
        <p>No reports available for this project.</p>
    {% endif %}

    <!--  modal add Report -->
    <button type="button" class="btn btn-secondary mt-3" data-bs-toggle="modal" data-bs-target="#addReportModal">
        {% trans "Add Report" %}
    </button>
    <a href="{% url 'dashboard' %}?project={{ project.id }}" class="btn btn-secondary mt-3">{% trans "Project view" %}</a>

    
</div>

<!-- Modal  Add Report -->
<div class="modal fade" id="addReportModal" tabindex="-1" aria-labelledby="addReportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{% url 'add_report' project.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addReportModalLabel">{% trans "Add report" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {{ form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="submit" class="btn btn-primary">{% trans "Save Report" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Script Copy Find -->
<!-- Script Copy Find -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const copyButtons = document.querySelectorAll('.copy-btn');

    copyButtons.forEach(button => {
        button.addEventListener('click', () => {
            let rawText = button.getAttribute('data-copy-text') || "";
            let textToCopy = rawText
                .split("\n")                 
                .map(line => line.trim())     
                .filter(line => line.length)   
                .join("\n");                  

            navigator.clipboard.writeText(textToCopy).then(() => {
                console.log("üìã Text copied -ok ");
            }).catch(err => console.error('‚ùå error on copy: ', err));
        });
    });
});
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
